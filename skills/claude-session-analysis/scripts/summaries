#!/usr/bin/env bun
// @bun

// src/resolve-session.ts
async function resolveSession(input) {
  if (await Bun.file(input).exists()) {
    return input;
  }
  if (!/^[a-f0-9-]+$/.test(input)) {
    throw new Error(`Invalid session ID: ${input}`);
  }
  const configDir = process.env.CLAUDE_CONFIG_DIR;
  const defaultDir = `${process.env.HOME}/.claude`;
  const searchDirs = [];
  if (configDir) {
    searchDirs.push(configDir);
    if (configDir !== defaultDir) {
      searchDirs.push(defaultDir);
    }
  } else {
    searchDirs.push(defaultDir);
  }
  const glob = new Bun.Glob(`projects/*/${input}*.jsonl`);
  for (const dir of searchDirs) {
    for (const match of glob.scanSync(dir)) {
      return `${dir}/${match}`;
    }
  }
  const searched = searchDirs.map((d) => `${d}/projects/*/`).join(", ");
  throw new Error(`Session not found: ${input}
  Searched in: ${searched}
  Hint: Use a full session ID or provide a direct file path`);
}

// src/summaries/extract.ts
function extractSummaries(entries) {
  return entries.filter((e) => e !== null && typeof e === "object" && !Array.isArray(e)).filter((e) => e.type === "summary").map((e) => e.summary);
}

// src/summaries/index.ts
async function main() {
  const input = process.argv[2];
  if (!input || input === "--help") {
    const prog = process.env._PROG || "summaries";
    console.log(`Usage: ${prog} <session_id_or_file>`);
    if (!input)
      process.exit(1);
    process.exit(0);
  }
  const sessionFile = await resolveSession(input);
  const text = await Bun.file(sessionFile).text();
  const rawLines = text.split(`
`).filter((line) => line.trim());
  const entries = [];
  for (const line of rawLines) {
    try {
      entries.push(JSON.parse(line));
    } catch {}
  }
  const summaries = extractSummaries(entries);
  await Bun.write(Bun.stdout, JSON.stringify(summaries, null, 2) + `
`);
}
main().catch((err) => {
  console.error(err.message);
  process.exit(1);
});
